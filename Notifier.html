<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grow a Garden Notifier</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-bg: #060e22;
      --secondary-bg: rgba(21,34,61,0.95);
      --tab-bg: #18254a;
      --tab-active-bg: #ffe066;
      --tab-active-text: #222;
      --tab-inactive-text: #ffe066;
      --tab-inactive-bg: #18254a;
      --accent: #ffe066;
      --card-bg: rgba(15,23,42,0.98);
      --item-selected-bg: #423f0b;
      --item-selected-border: #ffe066;
      --item-shadow: 0 2px 16px #1e1b4b33;
      --main-shadow: 0 8px 36px #0007;
      --notify-bg: #ffe066;
      --notify-text: #282828;
      --notify-shadow: 0 2px 7px #ffe06665;
      --notifying-bg: #fff3b0;
      --gear-border: #16c97c;
      --seed-border: #7db4ee;
      --egg-border: #e74c3c;
      --honey-border: #ffd166;
      --info-text: #7db4ee;
      --success: #70e97b;
      --error: #e74c3c;
      --transition: 0.13s;
      --border-radius: 16px;
      --font-main: 'Inter', 'Segoe UI', Arial, sans-serif;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--primary-bg);
      color: #fff;
      font-family: var(--font-main);
      min-height: 100vh;
    }
    body {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    .main-container {
      width: 100%;
      max-width: 650px;
      margin: 2.5em auto 0;
      background: var(--secondary-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--main-shadow);
      padding: 2em 1em 1.2em 1em;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .header {
      font-size: 2.1em;
      font-weight: 700;
      text-align: center;
      margin-bottom: .7em;
      color: var(--accent);
      letter-spacing: -1px;
      text-shadow: 0 1px 8px #ffe06622;
    }
    .category-tabs {
      display: flex;
      justify-content: center;
      gap: 1.2em;
      margin-bottom: 1.4em;
      margin-top: 0.7em;
      flex-wrap: wrap;
    }
    .category-tab {
      background: var(--tab-inactive-bg);
      color: var(--tab-inactive-text);
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 0.6em 1.3em;
      font-size: 1em;
      cursor: pointer;
      transition: background var(--transition), color var(--transition), box-shadow var(--transition);
    }
    .category-tab.active {
      background: var(--tab-active-bg);
      color: var(--tab-active-text);
      font-weight: 700;
      box-shadow: 0 2px 13px #ffe06644;
    }
    .button-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.2em;
      margin-bottom: 1.2em;
      margin-top: 0.2em;
    }
    .unotify-btn, .allnotify-btn {
      font-weight: 600;
      font-size: 1em;
      padding: 0.5em 1.5em;
      border-radius: 10px;
      outline: none;
      border: none;
      cursor: pointer;
      transition: background 0.13s, color 0.13s;
      box-shadow: 0 2px 7px #ffe06665;
      margin-bottom: 0;
    }
    .unotify-btn {
      background: #e74c3c;
      color: #fff;
      box-shadow: 0 2px 7px #ea8681;
    }
    .unotify-btn:hover, .unotify-btn:focus { background: #ff5c5c; color: #fff; }
    .allnotify-btn {
      background: #16c97c;
      color: #fff;
      box-shadow: 0 2px 7px #16c97c80;
    }
    .allnotify-btn:hover, .allnotify-btn:focus { background: #19e88f; color: #fff; }

    .restock-timer-bar {
      margin: 0 auto 1.5em auto;
      text-align: center;
      font-size: 1.08em;
      color: var(--accent);
      background: #19253e;
      border-radius: 11px;
      padding: 0.6em 1.2em 0.6em 1.2em;
      box-shadow: 0 2px 10px #0003;
      max-width: 400px;
      margin-bottom: 1.8em;
      letter-spacing: 0.02em;
      font-weight: 600;
    }
    .restock-timer-label {
      color: #b6d8ff;
      font-weight: 400;
      font-size: .97em;
      margin-right: 0.4em;
    }
    .item-list {
      display: flex;
      flex-direction: column;
      gap: 1.1em;
      min-height: 110px;
      max-height: 55vh;
      overflow-y: auto;
      padding: 0.2em;
    }
    .item-card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--item-shadow);
      padding: 0.9em 1.2em 0.8em 1.2em;
      display: flex;
      align-items: center;
      gap: 1.1em;
      position: relative;
      border-left: 6px solid transparent;
      transition: box-shadow var(--transition), background var(--transition), border-color var(--transition);
    }
    .item-card.selected {
      box-shadow: 0 4px 32px #ffe06655;
      border: 2px solid var(--item-selected-border);
      background: var(--item-selected-bg);
    }
    .item-card.gear { border-left: 6px solid var(--gear-border); }
    .item-card.seed { border-left: 6px solid var(--seed-border); }
    .item-card.egg { border-left: 6px solid var(--egg-border); }
    .item-card.honey { border-left: 6px solid var(--honey-border); }
    .item-icon {
      width: 54px;
      height: 54px;
      object-fit: contain;
      border-radius: 8px;
      background: #213164;
      flex-shrink: 0;
      border: 1.5px solid #333c5c;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .item-info {
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 0.05em;
    }
    .item-name {
      font-weight: 600;
      font-size: 1.09em;
      color: var(--accent);
      margin-bottom: 0.22em;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      max-width: 180px;
      display: block;
      letter-spacing: 0.01em;
    }
    .in-stock-badge {
      background: var(--success);
      color: #183c1c;
      border-radius: 5px;
      font-size: 0.93em;
      font-weight: 700;
      padding: 0.09em 0.8em;
      margin-bottom: 0.12em;
      display: inline-block;
      vertical-align: middle;
      box-shadow: 0 1px 4px #70e97b44;
      letter-spacing: 0.01em;
      width: fit-content;
      min-width: 56px;
      text-align: center;
    }
    .item-btn-col {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      gap: .5em;
      min-width: 110px;
      margin-left: 0.4em;
    }
    .notify-btn, .unnotify-btn-single {
      font-size: 1.01em;
      border: none;
      border-radius: 8px;
      padding: 0.34em 1.1em;
      font-weight: 600;
      box-shadow: 0 1px 4px #ffe06644;
      margin: 0;
      margin-bottom: 0.05em;
      margin-top: 0.05em;
      outline: none;
      cursor: pointer;
      transition: background 0.13s, color 0.13s, box-shadow 0.13s;
      display: inline-block;
      min-width: 85px;
      max-width: 120px;
      text-align: center;
    }
    .notify-btn {
      background: var(--notify-bg);
      color: var(--notify-text);
    }
    .notify-btn.active {
      background: var(--notifying-bg);
      color: var(--notify-text);
      font-weight: 700;
      box-shadow: 0 2px 9px #ffe06665;
    }
    .notify-btn:disabled { opacity: 0.65; cursor: default; }
    .unnotify-btn-single {
      background: #e74c3c;
      color: #fff;
      font-weight: 600;
      box-shadow: 0 1px 7px #ea8681;
    }
    .unnotify-btn-single:hover, .unnotify-btn-single:focus { background: #ff5c5c; color: #fff; }

    .modal-bg {
      display: none;
      position: fixed;
      z-index: 1001;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.38);
    }
    .modal-bg.active { display: block; }
    .modal {
      display: none;
      position: fixed;
      z-index: 1002;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      min-width: 270px;
      background: #19253e;
      padding: 2.2em 1.7em 1.2em 1.7em;
      border-radius: 18px;
      box-shadow: 0 8px 42px #000a;
      min-height: 50px;
      max-width: 98vw;
      max-height: 70vh;
      overflow-y: auto;
    }
    .modal.active { display: block; }
    .modal-title {
      font-size: 1.27em;
      color: var(--accent);
      font-weight: 700;
      margin-bottom: 0.8em;
      text-align: center;
    }
    .modal-list {
      margin-bottom: 1.2em;
      display: flex;
      flex-direction: column;
      gap: 0.6em;
      max-height: 35vh;
      overflow-y: auto;
    }
    .modal-item {
      font-size: 1.09em;
      color: #fff3b0;
      background: #202f57;
      border-radius: 8px;
      padding: 0.43em 1em;
      display: flex;
      align-items: center;
      gap: 0.8em;
    }
    .modal-unotify-one-btn {
      margin-left: auto;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.2em 1.1em;
      font-size: 0.97em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 7px #ea8681;
      transition: background 0.13s,color 0.13s;
    }
    .modal-unotify-one-btn:hover, .modal-unotify-one-btn:focus { background: #ff5c5c; color: #fff; }
    .modal-btn-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.2em;
      margin-bottom: 0.6em;
      margin-top: 1em;
    }
    .modal-unotify-btn {
      background: #e74c3c;
      color: #fff;
      font-weight: 600;
      padding: 0.5em 1.5em;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 2px 7px #ea8681;
      font-size: 1em;
      transition: background 0.13s,color 0.13s;
      outline: none;
      display: inline-block;
    }
    .modal-unotify-btn:hover, .modal-unotify-btn:focus { background: #ff5c5c; color: #fff; }
    .modal-close-btn {
      position: absolute;
      top: 0.6em;
      right: 1.3em;
      background: none;
      border: none;
      color: var(--accent);
      font-size: 1.7em;
      font-weight: bold;
      cursor: pointer;
      outline: none;
      transition: color 0.18s;
    }
    .modal-close-btn:hover { color: #fff; }
    .info-message {
      text-align: center;
      color: var(--info-text);
      font-size: 1.1em;
      margin: 0 0 1.3em 0;
      opacity: 0.98;
    }
    .notify-status {
      margin-top: 0.7em;
      font-size: 1.09em;
      text-align: center;
      color: var(--success);
      font-weight: 600;
      min-height: 1.9em;
    }
    @media (max-width: 700px) {
      .main-container { max-width: 99vw; margin-top: 1.2em; }
      .item-list { max-height: 60vh; }
      .restock-timer-bar { max-width: 95vw; }
    }
    @media (max-width: 540px) {
      .item-btn-col { min-width: 80px; max-width: 130px; }
      .notify-btn, .unnotify-btn-single { min-width: 74px; max-width: 100px; font-size: 0.96em;}
      .item-name { font-size: 0.9em; }
    }
    @media (max-width: 450px) {
      .main-container { padding: 1em 0.2em; }
      .item-card { padding: 0.6em 0.3em; }
      .item-name { font-size: 0.86em; }
      .header { font-size: 1.3em; }
      .restock-timer-bar { padding: 0.45em 0.3em; font-size: 0.97em; }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="header">Grow a Garden Notifier</div>
    <div class="category-tabs">
      <button class="category-tab active" data-tab="seeds">Seeds</button>
      <button class="category-tab" data-tab="gear">Gear</button>
      <button class="category-tab" data-tab="eggs">Eggs</button>
      <button class="category-tab" data-tab="honey">Honey Event</button>
    </div>
    <div class="button-row">
      <button class="unotify-btn" id="unotifyAllBtn" type="button">UnNotify All</button>
      <button class="allnotify-btn" id="allNotifyBtn" type="button">All Notify</button>
    </div>
    <div class="restock-timer-bar" id="restockTimerBar">Loading restock timer...</div>
    <div class="info-message">
      Select items to be notified when they're in stock.<br>
      <span style="color:var(--accent);">Notifications require permission and work best on modern browsers.</span>
    </div>
    <div class="item-list" id="itemList"></div>
    <div class="notify-status" id="notifyStatus"></div>
  </div>
  <div class="modal-bg" id="modalBg"></div>
  <div class="modal" id="allNotifyModal">
    <button class="modal-close-btn" id="closeModalBtn" title="Close">&times;</button>
    <div class="modal-title">All Notified Items</div>
    <div class="modal-list" id="modalList"></div>
    <div class="modal-btn-row">
      <button class="modal-unotify-btn" id="modalUnotifyBtn" type="button">UnNotify All</button>
    </div>
  </div>
  <script>
  
    const SEED_NAMES = [
      "Carrot","Strawberry","Blueberry","Orange Tulip","Tomato","Corn","Daffodil","Watermelon",
      "Pumpkin","Apple","Bamboo","Coconut","Cactus","Dragon Fruit","Mango","Grape","Mushroom",
      "Pepper","Cacao","Beanstalk","Ember Lily","Sugar Apple"
    ];
    const GEAR_NAMES = [
      "Watering Can","Trowel","Favorite Tool","Harvest Tool",
      "Basic Sprinkler","Advanced Sprinkler","Godly Sprinkler",
      "Master Sprinkler","Recall Wrench","Lightning Rod","Friedship Pot"
    ];
    const EGG_NAMES = [
      "Common Egg","Uncommon Egg","Rare Egg","Legendary Egg","Bug Egg"
    ];
    const HONEY_NAMES = [
      "Flower Seed Pack","Lavender Seed","Nectarshade Seed","Nectarine Seed","Hive Fruit Seed",
      "Pollen Radar","Nectar Staff","Honey Sprinkler","Bee Egg","Bee Crate","Honey Comb",
      "Bee Chair","Honey Torch","Honey Walkway"
    ];

    function getCategory(name) {
      if (SEED_NAMES.includes(name)) return "seed";
      if (GEAR_NAMES.includes(name)) return "gear";
      if (EGG_NAMES.includes(name)) return "egg";
      if (HONEY_NAMES.includes(name)) return "honey";
      return "";
    }


    const NOTIFY_KEY = "garden_notifier_items_v2";
    const PERM_KEY = "garden_notify_perm";
    let notifyList = [];
    let itemDataMap = {};
    let lastStockState = {};
    let lastStockNotified = {};
    let pollingInterval = null;
    let allItemsFetched = false;
    let currentTab = "seeds";
    let restockData = null, restockInterval = null;
    let liveRestockTimestamp = null;
    const itemListEl = document.getElementById('itemList');
    const restockTimerBar = document.getElementById('restockTimerBar');
    const modalBg = document.getElementById('modalBg');
    const allNotifyModal = document.getElementById('allNotifyModal');
    const modalList = document.getElementById('modalList');
    function loadNotifyList() {
      try {
        const raw = localStorage.getItem(NOTIFY_KEY);
        notifyList = raw ? JSON.parse(raw) : [];
      } catch { notifyList = []; }
    }
    function saveNotifyList() {
      localStorage.setItem(NOTIFY_KEY, JSON.stringify(notifyList));
    }
    function hasNotificationPermission() {
      return Notification.permission === "granted" || localStorage.getItem(PERM_KEY) === "granted";
    }
    function setNotificationPermission(granted) {
      if (granted) localStorage.setItem(PERM_KEY, "granted");
      else localStorage.removeItem(PERM_KEY);
    }
    function notifyStatus(msg, color=undefined) {
      const s = document.getElementById('notifyStatus');
      if (!msg) { s.textContent = ""; return; }
      s.textContent = msg; if (color) s.style.color = color;
      else s.style.color = "var(--success)";
    }
    function startNotifier(itemName, askPerm=true) {
      if (!("Notification" in window)) {
        notifyStatus("Notifications not supported by your browser.", "var(--accent)");
        return;
      }
      if (Notification.permission !== "granted" && askPerm) {
        Notification.requestPermission().then(function(permission) {
          setNotificationPermission(permission === "granted");
          if (permission === "granted") {
            startNotifier(itemName, false);
          } else {
            notifyStatus("Notification permission denied.", "var(--accent)");
          }
        });
        return;
      }
      if (!notifyList.includes(itemName)) {
        notifyList.push(itemName); saveNotifyList();
      }
      notifyStatus("Notifier enabled for selected items.");
      startPolling();
      renderList(currentTab, lastStockState);
    }
    function stopNotifier(itemName) {
      notifyList = notifyList.filter(n => n !== itemName);
      saveNotifyList();
      notifyStatus("Notifier updated.");
      renderList(currentTab, lastStockState);
      renderModalList();
      updateAllNotifyBtn();
    }
    function toggleNotifyItem(itemName) {
      if (!notifyList.includes(itemName)) startNotifier(itemName);
      else stopNotifier(itemName);
    }
    function sendStockNotification(item, msg) {
      if (Notification.permission === "granted" || hasNotificationPermission()) {
        new Notification(
          "Grow a Garden: " + item,
          { body: msg, icon: (itemDataMap[item]?.icon || ""), tag: "growagarden-stock-" + (itemDataMap[item]?.item_id || item) }
        );
      }
    }
    function startPolling() {
      if (pollingInterval) clearInterval(pollingInterval);
      pollingInterval = setInterval(checkStock, 4000);
      checkStock();
    }
    async function checkStock() {
      if (!notifyList.length) return;
      try {
        const resp = await fetch('https://api.joshlei.com/v2/growagarden/stock');
        if (!resp.ok) throw new Error();
        const stock = await resp.json();
        let foundAny = false, currentStock = {};
        let stockMap = {};

        ["seed_stock", "gear_stock", "egg_stock", "eventshop_stock"].forEach(group => {
          if (stock[group]) {
            stock[group].forEach(item => {
              if (item && item.item_id) stockMap[item.item_id] = item;
            });
          }
        });
        let restockTimestamp = getCurrentRestockTimestampForTab(currentTab);
        notifyList.forEach(itemName => {
          const item = itemDataMap[itemName];
          if (!item) return;
          const s = stockMap[item.item_id];
          const inStock = !!(s && (s.quantity > 0));
          currentStock[itemName] = inStock;

          if (
            inStock &&
            restockTimestamp &&
            (
              !lastStockNotified[itemName] ||
              lastStockNotified[itemName] !== restockTimestamp
            )
          ) {
            sendStockNotification(itemName, "Now in stock!");
            lastStockNotified[itemName] = restockTimestamp;
            foundAny = true;
          }
        });
        let inStockItems = notifyList.filter(n => currentStock[n]);
        if (inStockItems.length > 0) {
          notifyStatus("In stock: " + inStockItems.join(", ") + ". Monitoring continues.");
        } else {
          notifyStatus("Waiting for restock...", "var(--accent)");
        }
        lastStockState = { ...lastStockState, ...currentStock };
        renderList(currentTab, currentStock);
      } catch (e) {
        notifyStatus("Failed to check stock.", "var(--accent)");
      }
    }
    function getRestockCategoryForTab(tab) {
      if (tab === "seeds") return "seeds";
      if (tab === "gear") return "gear";
      if (tab === "eggs") return "egg";
      if (tab === "honey") return "Event";
      return null;
    }
    function getCurrentRestockTimestampForTab(tab) {
      const cat = getRestockCategoryForTab(tab);
      if (!cat || !restockData || !restockData[cat]) return null;
      return restockData[cat].timestamp || null;
    }
    async function fetchRestockDataAndStartTimer() {
      try {
        const resp = await fetch('https://growagardenapi.vercel.app/api/stock/Restock-Time');
        if (!resp.ok) throw new Error("Failed to fetch restock time");
        restockData = await resp.json();
        updateRestockBar();
        if (restockInterval) clearInterval(restockInterval);
        restockInterval = setInterval(updateRestockBar, 1000);
      } catch {
        restockTimerBar.textContent = "Failed to load restock timer.";
      }
    }
    function updateRestockBar() {
      if (!restockData) return;
      const cat = getRestockCategoryForTab(currentTab);
      if (!cat || !restockData[cat]) {
        restockTimerBar.textContent = "No restock data available.";
        return;
      }
      const data = restockData[cat];
      liveRestockTimestamp = data.timestamp;
      let diff = data.timestamp - Date.now();
      if (diff < 0) diff = 0;
      const h = Math.floor(diff / 3600000);
      const m = Math.floor((diff % 3600000) / 60000);
      const s = Math.floor((diff % 60000) / 1000);
      const countdownStr = `${h.toString().padStart(2,'0')}h ${m.toString().padStart(2,'0')}m ${s.toString().padStart(2,'0')}s`;
      restockTimerBar.innerHTML =
        `<span class="restock-timer-label">Next ${currentTab.charAt(0).toUpperCase() + currentTab.slice(1)} restock:</span> <span>${countdownStr}</span>`;
      if (diff === 0) {
        fetchRestockDataAndStartTimer();
        checkStock();
      }
    }
    function renderList(categoryKey, stockState = undefined) {
      itemListEl.innerHTML = "";
      let items = [];
      if (!allItemsFetched) {
        itemListEl.innerHTML = '<div style="color:#ffe066;text-align:center;padding:1.2em;">Loading items...</div>';
        return;
      }
      if (categoryKey === "seeds") {
        items = SEED_NAMES.map(n => itemDataMap[n]).filter(Boolean);
      } else if (categoryKey === "gear") {
        items = GEAR_NAMES.map(n => itemDataMap[n]).filter(Boolean);
      } else if (categoryKey === "eggs") {
        items = EGG_NAMES.map(n => itemDataMap[n]).filter(Boolean);
      } else if (categoryKey === "honey") {
        items = HONEY_NAMES.map(n => itemDataMap[n]).filter(Boolean);
      }
      items.forEach(item => {
        const card = document.createElement('div');
        card.className = `item-card ${getCategory(item.display_name)}` + (notifyList.includes(item.display_name) ? " selected" : "");
    
        const iconDiv = document.createElement('div');
        iconDiv.className = "item-icon";
        const img = document.createElement("img");
        img.src = item.icon;
        img.alt = item.display_name;
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "contain";
        img.draggable = false;
        iconDiv.appendChild(img);
        card.appendChild(iconDiv);

        const infoDiv = document.createElement('div');
        infoDiv.className = "item-info";
        const nameDiv = document.createElement('div');
        nameDiv.className = "item-name";
        nameDiv.textContent = item.display_name;
        infoDiv.appendChild(nameDiv);

        if (
          notifyList.includes(item.display_name) &&
          stockState && typeof stockState[item.display_name] === "boolean" && stockState[item.display_name]
        ) {
          const badge = document.createElement('span');
          badge.className = 'in-stock-badge';
          badge.textContent = "In Stock";
          infoDiv.appendChild(badge);
        }
        card.appendChild(infoDiv);

        const btnCol = document.createElement('div');
        btnCol.className = 'item-btn-col';
        if (notifyList.includes(item.display_name)) {
          const nbtn = document.createElement('button');
          nbtn.className = 'notify-btn active';
          nbtn.textContent = "Notifying";
          nbtn.disabled = true;
          btnCol.appendChild(nbtn);

          const unbtn = document.createElement('button');
          unbtn.className = 'unnotify-btn-single';
          unbtn.textContent = "UnNotify";
          unbtn.onclick = e => { e.stopPropagation(); stopNotifier(item.display_name); };
          btnCol.appendChild(unbtn);
        } else {
          const btn = document.createElement('button');
          btn.className = 'notify-btn';
          btn.textContent = "Notify";
          btn.onclick = e => { e.stopPropagation(); startNotifier(item.display_name); };
          btnCol.appendChild(btn);
        }
        card.appendChild(btnCol);
        itemListEl.appendChild(card);
      });
    }
    function setActiveTab(tabKey) {
      document.querySelectorAll('.category-tab').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabKey);
      });
      currentTab = tabKey;
      renderList(tabKey, lastStockState);
      updateRestockBar();
    }
    document.querySelectorAll('.category-tab').forEach(btn => {
      btn.addEventListener('click', e => {
        setActiveTab(e.target.dataset.tab);
      });
    });
    async function fetchAndInit() {
      loadNotifyList();
      itemListEl.innerHTML = '<div style="color:#ffe066;text-align:center;padding:1.2em;">Loading items...</div>';
      try {
        const resp = await fetch('https://api.joshlei.com/v2/growagarden/info');
        if (!resp.ok) throw new Error("Failed to fetch items");
        const items = await resp.json();
        itemDataMap = {};
        for (const item of items) {
          if (
            SEED_NAMES.includes(item.display_name) ||
            GEAR_NAMES.includes(item.display_name) ||
            EGG_NAMES.includes(item.display_name) ||
            HONEY_NAMES.includes(item.display_name)
          ) {
            itemDataMap[item.display_name] = item;
          }
        }
        allItemsFetched = true;
        renderList(currentTab, lastStockState);
        if (notifyList.length > 0) startPolling();
        updateAllNotifyBtn();
      } catch (e) {
        itemListEl.innerHTML = '<div style="color:#ffe066;text-align:center;padding:1.2em;">Failed to load items.<br>'+e+'</div>';
      }
    }

    function showAllNotifiedMenu() {
      renderModalList();
      modalBg.classList.add('active');
      allNotifyModal.classList.add('active');
    }
    function closeModal() {
      modalBg.classList.remove('active');
      allNotifyModal.classList.remove('active');
    }
    function renderModalList() {
      modalList.innerHTML = "";
      if (!notifyList.length) {
        modalList.innerHTML = '<div style="color:#ffe066;text-align:center;padding:0.9em;">No items are being notified.</div>';
        return;
      }
      notifyList.forEach(n => {
        const item = itemDataMap[n];
        if (!item) return;
        const div = document.createElement('div');
        div.className = 'modal-item';
        if (item.icon) {
          const img = document.createElement('img');
          img.src = item.icon;
          img.alt = item.display_name || n;
          img.style.width = "32px";
          img.style.height = "32px";
          img.style.objectFit = "contain";
          img.style.borderRadius = "6px";
          img.style.background = "#0b1427";
          div.appendChild(img);
        }
        div.appendChild(document.createTextNode(item.display_name));
        const unnotifyBtn = document.createElement('button');
        unnotifyBtn.className = 'modal-unotify-one-btn';
        unnotifyBtn.textContent = 'Unnotify';
        unnotifyBtn.onclick = (e) => {
          e.stopPropagation();
          stopNotifier(n);
        };
        div.appendChild(unnotifyBtn);
        modalList.appendChild(div);
      });
    }
    function unotifyAll() {
      notifyList = [];
      saveNotifyList();
      notifyStatus("All notifiers removed.", "#e74c3c");
      renderList(currentTab, lastStockState);
      renderModalList();
      updateAllNotifyBtn();
      closeModal();
    }
    function notifyAll() {
      if (!("Notification" in window)) {
        notifyStatus("Notifications not supported by your browser.", "var(--accent)");
        return;
      }
      if (Notification.permission !== "granted") {
        Notification.requestPermission().then(function(permission) {
          setNotificationPermission(permission === "granted");
          if (permission !== "granted") {
            notifyStatus("Notification permission denied.", "var(--accent)");
            return;
          }
          notifyAll();
        });
        return;
      }
      notifyList = Object.keys(itemDataMap);
      saveNotifyList();
      notifyStatus("Notifier enabled for all items.");
      startPolling();
      renderList(currentTab, lastStockState);
      renderModalList();
      updateAllNotifyBtn();
    }
    function updateAllNotifyBtn() {
      const btn = document.getElementById('allNotifyBtn');
      if (!notifyList.length) {
        btn.textContent = "All Notify";
      } else {
        btn.textContent = "All Notify (" + notifyList.length + ")";
      }
    }
    document.getElementById('unotifyAllBtn').addEventListener('click', unotifyAll);
    document.getElementById('allNotifyBtn').addEventListener('click', showAllNotifiedMenu);
    document.getElementById('modalUnotifyBtn').addEventListener('click', unotifyAll);
    document.getElementById('closeModalBtn').addEventListener('click', closeModal);
    document.getElementById('modalBg').addEventListener('click', closeModal);

    fetchAndInit();
    fetchRestockDataAndStartTimer();
    if ("Notification" in window && Notification.permission === "default" && !localStorage.getItem("garden_notify_perm")) {
      Notification.requestPermission().then(function(permission) {
        setNotificationPermission(permission === "granted");
      });
    }
  </script>
</body>
</html>
